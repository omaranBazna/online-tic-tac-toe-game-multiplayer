<html>
<head>
<link href="style.css" rel="stylesheet" />
<title>Tic Tac Toe</title>

<style>
h1{
    font-family:Arial;
    text-align:center;
  
}
.board{
display:flex;
flex-direction: column;
align-items:center;
justify-content: center;
}
.board .row{
    display:flex;
    align-items: center;
    justify-content: center;
}
.cell{
height:100px;
width:100px;
border:1px solid black;
margin:5px;
font-size:40px;
font-family: Arial, Helvetica, sans-serif;
line-height:100px;
text-align:center;
}


</style>
</head>

<body>
<header>
  <h1>Tic Tac Toe</h1>
</header>
<main>
  <div class="board">
    <div class="row">
      <div class="cell" data-cor="0-0"></div>
      <div class="cell" data-cor="0-1"></div>
      <div class="cell" data-cor="0-2"></div>
    </div>
    <div class="row">
      <div class="cell" data-cor="1-0"></div>
      <div class="cell" data-cor="1-1"></div>
      <div class="cell" data-cor="1-2"></div>
    </div>
    <div class="row">
      <div class="cell" data-cor="2-0"></div>
      <div class="cell" data-cor="2-1"></div>
      <div class="cell" data-cor="2-2"></div>
    </div>
  </div>
  <div class="Player"></div>
  <div class="error" ></div>
  <div>Turn is : <span class="turn"></span></div>
  <div class="msg"></div>
</main>
<footer>

</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.js" integrity="sha512-nO7wgHUoWPYGCNriyGzcFwPSF+bPDOR+NvtOYy2wMcWkrnCNPKBcFEkU80XIN14UVja0Gdnff9EmydyLlOL7mQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script >
let gplayer;
let groom_id;
let end=false;
fetch("/getdata")
  .then((res) => res.json())
  .then(({ player, room_id }) => {
   
    if (player == "x") {
      $(".player").html("X");
      gplayer = "x";
    } else {
      $(".player").html("O");
      gplayer = "o";
    }
    groom_id = room_id;
    console.log("player setted to be "+gplayer)
    console.log("room setted to "+groom_id)
  });


setInterval(()=>{
  fetch("/check",{
    method:"post",
    headers:{
      "Content-Type":"application/json"
    },
    body:JSON.stringify({id:groom_id})
  }).then(res=>{
    return res.json();
  }).then(room=>{
    const {turn,state,winner}=room;
    console.log("winner: ",winner)
   
  $(".turn").html(turn);
   console.log("state :",state)
   
    if(winner==1){
     $(".msg").html("X win!!")
     end=true;
    }else if(winner==2){
      $(".msg").html("O win!!")
      end=true;
    }else if(winner==3){
      $(".msg").html("Draw")
      end=true;
    }
 
    for(let i=0;i<3;i++){
          for(let j=0;j<3;j++){
            console.log(state[i][j])
            const el2=$(`div[data-cor=${i}-${j}]`)
            el2.html(state[i][j]==0?"":state[i][j]==1?"X":"O")
          }
        }
      
  }).catch(e=>console.log(e))
},300)


$(".cell").click(function () {

  const el = $(this);
  const [x, y] = $(this).attr("data-cor").split("-");
  console.log("Player "+gplayer)
  fetch("/move", {
    method: "post",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({ x, y, player:gplayer, id: groom_id }),
  })
    .then((res) => {
      return res.json();
    })
    .then(({ err, msg,state,winner }) => {
      if (err) {
        $(".error").html(msg);
      } else {
      
        if(winner==1){
     $(".msg").html("X win!!")
     end=true;
    }else if(winner==2){
      $(".msg").html("O win!!")
      end=true;
    }else if(winner==3){
      $(".msg").html("Draw")
      end=true;
    }


        $(".error").html("");
      if(!end){
        for(let i=0;i<3;i++){
          for(let j=0;j<3;j++){
            console.log(state[i][j])
            const el2=$(`div[data-cor=${i}-${j}]`)
         
            el2.html(state[i][j]==0?"":state[i][j]==1?"X":"O")
          }
        }
      }
      }
    });
});


</script>
</body>

</html>